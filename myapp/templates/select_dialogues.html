<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Select Dialogues</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: #f8f9fa;
            padding: 10px;
            border-top: 1px solid #ccc;
        }
        .message-text {
            white-space: pre-wrap; /* Сохраняем пробелы и переносы строк */
        }
        .highlight {
            background-color: yellow; /* Цвет подсветки */
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3">
                <h1>Поиск Диалогов</h1>
                <input type="text" id="searchInput" class="form-control" placeholder="Поиск диалогов..." autocomplete="off">
                <div id="searchResults"></div>
            </div>
            <div class="col-md-9">
                <h2>Добавленные Диалоги</h2>
                <ul id="addedDialogues" class="list-group">
                    {% for dialogue in added_dialogues %}
                    <li class="list-group-item" data-dialogue-id="{{ dialogue.dialogue_id }}">
                        {{ dialogue.name }}
                        <button class="btn btn-sm btn-primary view-messages" data-id="{{ dialogue.dialogue_id }}">Просмотр</button>
                        <button class="btn btn-sm btn-danger delete-dialogue" data-id="{{ dialogue.dialogue_id }}">Удалить</button>
                    </li>
                    {% endfor %}
                </ul>
                <button id="loadMessagesButton" class="btn btn-primary">Загрузить Сообщения</button>
                <button id="loadDialoguesFromTelegramButton" class="btn btn-primary">Загрузить Диалоги из Telegram</button>
                <h2>Поиск Сообщений</h2>
                <input type="text" id="searchMessagesInput" class="form-control" placeholder="Поиск сообщений..." autocomplete="off">
                <div id="messageSearchResults"></div>
            </div>
        </div>
    </div>
    <div class="footer">
        <h2>Недавние Сообщения</h2>
        <div id="recentMessagesContainer" class="d-none">
            <button id="closeMessagesButton" class="btn btn-sm btn-danger mb-2">Закрыть Сообщения</button>
            <ul id="recentMessages" class="list-group"></ul>
        </div>
    </div>

    <script>
    $(document).ready(function() {
        $('#searchInput').on('keyup', function() {
            var query = $(this).val();
            if (query.length > 0) {
                $.ajax({
                    url: '/search-dialogues/',
                    data: { 'search': query },
                    success: function(data) {
                        $('#searchResults').html(data);
                    }
                });
            } else {
                $('#searchResults').empty();
            }
        });

        $(document).on('click', '.add-dialogue', function() {
            var dialogueId = $(this).data('id');
            var dialogueName = $(this).data('name');
            $.ajax({
                url: '/add-dialogue/',
                method: 'POST',
                data: {
                    'dialogue_id': dialogueId,
                    'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
                },
                success: function() {
                    $('#addedDialogues').append('<li class="list-group-item" data-dialogue-id="' + dialogueId + '">' + dialogueName + ' <button class="btn btn-sm btn-primary view-messages" data-id="' + dialogueId + '">Просмотр Сообщений</button> <button class="btn btn-sm btn-danger delete-dialogue" data-id="' + dialogueId + '">Удалить</button></li>');
                }
            });
        });

        $('#loadMessagesButton').on('click', function() {
            $.ajax({
                url: '/load-dialogues/',
                success: function(data) {
                    $('#addedDialogues').html(data);
                }
            });
        });

        $('#loadDialoguesFromTelegramButton').on('click', function() {
            $.ajax({
                url: '/load-dialogues-from-telegram/',
                success: function(data) {
                    alert(data.message);
                    // Загрузить диалоги после обновления
                    $('#loadMessagesButton').click();
                }
            });
        });

        $(document).on('click', '.view-messages', function() {
            var dialogueId = $(this).data('id');
            $.ajax({
                url: '/get-recent-messages/',
                data: { 'dialogue_id': dialogueId },
                success: function(data) {
                    $('#recentMessages').html(data);
                    $('#recentMessagesContainer').removeClass('d-none');
                }
            });
        });

        $(document).on('click', '.delete-dialogue', function() {
            var dialogueId = $(this).data('id');
            $.ajax({
                url: '/delete-dialogue/',
                method: 'POST',
                data: {
                    'dialogue_id': dialogueId,
                    'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
                },
                success: function(response) {
                    if (response.status === 'success') {
                        $('li[data-dialogue-id="' + dialogueId + '"]').remove();
                    } else {
                        alert('Ошибка: ' + response.message);
                    }
                }
            });
        });

        $('#closeMessagesButton').on('click', function() {
            $('#recentMessagesContainer').addClass('d-none');
            $('#recentMessages').empty();
        });

        $('#searchMessagesInput').on('keyup', function() {
            var query = $(this).val();
            if (query.length > 0) {
                $.ajax({
                    url: '/search-messages/',
                    data: { 'search': query },
                    success: function(data) {
                        $('#messageSearchResults').html(data);
                        highlightText(query);
                    }
                });
            } else {
                $('#messageSearchResults').empty();
            }
        });

        function highlightText(query) {
            $('.message-text').each(function() {
                var text = $(this).html();
                var regex = new RegExp('(' + query + ')', 'gi');
                var newText = text.replace(regex, '<span class="highlight">$1</span>');
                $(this).html(newText);
            });
        }
    });
    </script>
</body>
</html>
